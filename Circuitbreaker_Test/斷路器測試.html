<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spring Boot æ–·è·¯å™¨å£“æ¸¬èˆ‡ç›£æ§å·¥å…·</title>
  <!-- 
    å–®æª”ç´”å‰ç«¯å·¥å…·ï¼šä»¥ç€è¦½å™¨ç™¼é€è² è¼‰åˆ°æŒ‡å®š URLï¼Œä¸¦é€é Actuator æŸ¥è©¢ Resilience4j æ–·è·¯å™¨ç‹€æ…‹ã€‚
    ç‰¹è‰²
    - å¯è¨­å®šï¼šæŒçºŒæ™‚é–“ã€æ¯ç§’è«‹æ±‚æ•¸(RPS)ã€æœ€å¤§ä¸¦è¡Œæ•¸ã€CORS æ¨¡å¼ã€credentialsã€é€¾æ™‚ã€HTTP æ–¹æ³•/Headers/Body
    - å³æ™‚åœ–è¡¨ï¼šå¯¦éš› RPS èˆ‡å¹³å‡å»¶é²ã€æ–·è·¯å™¨ç‹€æ…‹(Closed/Half-Open/Open)
    - Actuator ç›£æ§ï¼š/actuator/circuitbreakersã€/actuator/circuitbreakereventsã€/actuator/metrics*
    - å…¶ä»–ï¼šå–®ç™¼æ¸¬è©¦ã€ä¸‹è¼‰ CSV çµ±è¨ˆã€äº‹ä»¶æ—¥èªŒã€å„²å­˜/è¼‰å…¥è¨­å®šã€æ·±/æ·ºè‰²ä¸»é¡Œ

    æ³¨æ„äº‹é …
    - è·¨ç¶²åŸŸè«‹æ±‚éœ€è¦å¾Œç«¯æ­£ç¢ºè¨­å®š CORSï¼ˆå« Actuatorï¼‰ã€‚å¯åƒè€ƒï¼š
      management.endpoints.web.cors.allowed-origins=http://localhost:*,http://127.0.0.1:*
      management.endpoints.web.cors.allowed-methods=GET,POST,PUT,DELETE,OPTIONS
      management.endpoints.web.cors.allowed-headers=*
      management.endpoints.web.exposure.include=health,info,metrics,circuitbreakers,circuitbreakerevents
    - è‹¥ä»¥ no-cors ç™¼é€ï¼Œresponse å°‡ç‚º opaqueï¼ˆç„¡æ³•è®€å–ç‹€æ…‹/å…§å®¹ï¼‰ã€‚
  -->
  <style>
    :root{
      --bg: #0b0d10;
      --panel: #11151a;
      --text: #e7eef5;
      --muted: #9db0c5;
      --border: #233042;
      --accent: #5fb3ff;
      --good: #35c759;
      --warn: #ff9f0a;
      --bad:  #ff453a;
      --shadow: rgba(11, 15, 26, 0.6);
    }
    [data-theme="light"]{
      --bg:#f6f8fb;
      --panel:#ffffff;
      --text:#0b0d10;
      --muted:#566374;
      --border:#dfe6ef;
      --accent:#1b76e5;
      --good:#15803d;
      --warn:#b45309;
      --bad:#b91c1c;
      --shadow: rgba(17, 30, 63, 0.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      background-image:radial-gradient(circle at top, rgba(95,179,255,0.12), transparent 55%);
      color:var(--text);
      font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,PingFang TC,Helvetica Neue,Arial;
      color-scheme:dark;
      min-height:100vh;
      letter-spacing:0.01em;
    }
    body[data-theme="light"]{
      color-scheme:light;
      background:var(--bg);
      background-image:radial-gradient(circle at top, rgba(27,118,229,0.08), transparent 60%);
    }
    h1{font-size:20px;margin:0;color:var(--text)}
    h2{font-size:16px;margin:0;color:var(--muted)}
    a{color:var(--accent)}
    .container{
      display:grid;
      grid-template-columns:minmax(320px, 360px) 1fr;
      gap:18px;
      height:100%;
      padding:24px clamp(16px,4vw,36px);
      max-width:1440px;
      margin:0 auto;
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:20px;
      overflow:auto;
      box-shadow:0 18px 36px -28px var(--shadow);
      transition:transform 0.2s ease, box-shadow 0.2s ease;
    }
    .panel:hover{
      transform:translateY(-2px);
      box-shadow:0 22px 48px -32px rgba(95,179,255,0.25);
    }
    .panel > * + *{margin-top:16px}
    .panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding-bottom:12px;
      border-bottom:1px solid var(--border);
    }
    .panel-header h1{font-size:22px;margin:0}
    .panel-header .switch{margin-left:auto}
    .row{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px}
    .row-3{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:12px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:600}
    input,select,textarea{
      width:100%;
      background:rgba(255,255,255,0.02);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:9px;
      transition:border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }
    textarea{min-height:92px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(95,179,255,0.18);
      outline:none;
      background:rgba(95,179,255,0.08);
    }
    .shortcut-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .btns{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    button{
      background:var(--accent);
      border:none;
      color:white;
      border-radius:12px;
      padding:9px 14px;
      cursor:pointer;
      transition:transform 0.15s ease, box-shadow 0.15s ease, background-color 0.2s ease;
      box-shadow:0 10px 26px -18px rgba(95,179,255,0.7);
      font-weight:600;
      letter-spacing:0.02em;
    }
    button:hover{transform:translateY(-1px);box-shadow:0 14px 32px -18px rgba(95,179,255,0.9)}
    button:active{transform:translateY(0);box-shadow:0 6px 16px -14px rgba(95,179,255,0.6)}
    button:disabled{opacity:.45;cursor:not-allowed;transform:none;box-shadow:none}
    button.secondary{
      background:rgba(255,255,255,0.02);
      color:var(--text);
      border:1px solid var(--border);
      box-shadow:none;
    }
    button.secondary:hover{background:rgba(95,179,255,0.12)}
    button.warn{background:var(--warn);color:#111}
    button.bad{background:var(--bad)}
    .btn-compact{font-size:11px;padding:3px 8px;font-weight:500}
    .kpi{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
      gap:12px;
    }
    .kpi .card{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:linear-gradient(180deg, rgba(95,179,255,0.05), transparent);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpi .val{font-size:22px;font-weight:700}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .logs{
      font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
      white-space:pre-wrap;
      background:rgba(12,18,24,0.35);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      height:200px;
      overflow:auto;
    }
    .badge{
      display:inline-block;
      border:1px solid var(--border);
      padding:2px 8px;
      border-radius:99px;
      color:var(--muted);
      font-size:12px;
      letter-spacing:0.08em;
    }
    .divider{height:1px;background:var(--border);margin:8px 0 4px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{
      border-bottom:1px solid var(--border);
      padding:8px;
      text-align:left;
      font-size:12px;
      white-space:nowrap;
    }
    .table td:last-child{white-space:normal}
    .event-container{
      max-height:260px;
      overflow-y:auto;
      border:1px solid var(--border);
      border-radius:12px;
      background:rgba(255,255,255,0.02);
    }
    .switch{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .switch input{width:auto}
    .footer{opacity:.72;font-size:12px;margin-top:4px;line-height:1.6}
    .grid2{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:16px;
    }
    canvas{
      width:100%!important;
      height:240px!important;
      background:rgba(8,12,18,0.25);
      border-radius:12px;
    }
    .sticky-actions{
      position:sticky;
      bottom:0;
      background:linear-gradient(180deg,rgba(17,21,26,0), var(--panel));
      padding-top:12px;
      margin-top:12px;
      border-top:1px solid var(--border);
    }
    @media (max-width:1200px){
      .container{grid-template-columns:1fr;height:auto;padding:20px}
      #leftPanel{order:2}
    }
    @media (max-width:900px){
      .row,.row-3{grid-template-columns:1fr}
      .panel-header{flex-direction:column;align-items:flex-start}
      .panel-header .switch{margin-left:0}
      .btns button{flex:1 1 48%}
      canvas{height:220px!important}
    }
    @media (max-width:600px){
      .container{padding:16px}
      .btns{gap:6px}
      .btns button{flex:1 1 100%}
      .shortcut-row button{flex:1 1 48%}
      canvas{height:200px!important}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
</head>
<body>
  <div class="container">
    <!-- å·¦ï¼šè¨­å®šèˆ‡æ§åˆ¶ -->
    <div class="panel" id="leftPanel">
      <div class="panel-header">
        <h1>æ–·è·¯å™¨å£“æ¸¬èˆ‡ç›£æ§å·¥å…·</h1>
        <div class="switch" title="æ·±/æ·ºè‰²ä¸»é¡Œ">
          <input type="checkbox" id="themeToggle" />
          <label for="themeToggle">æ·ºè‰²</label>
        </div>
      </div>

      <h2>è«‹æ±‚è¨­å®š</h2>
      <div class="row">
        <div>
          <label>ç›®æ¨™è«‹æ±‚å®Œæ•´ URL</label>
          <input id="targetUrl" placeholder="ä¾‹å¦‚ï¼šhttp://localhost:8080/api/demo" />
        </div>
        <div>
          <label>HTTP æ–¹æ³•</label>
          <select id="method">
            <option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option><option>PATCH</option><option>HEAD</option><option>OPTIONS</option>
          </select>
        </div>
      </div>
      <div class="row-3">
        <div>
          <label>æŒçºŒæ™‚é–“ (ç§’)</label>
          <input id="duration" type="number" min="1" value="20" />
        </div>
        <div>
          <label>æ¯ç§’è«‹æ±‚æ•¸ RPS</label>
          <input id="rps" type="number" min="0" value="10" />
        </div>
        <div>
          <label>æœ€å¤§ä¸¦è¡Œæ•¸</label>
          <input id="concurrency" type="number" min="1" value="20" />
        </div>
      </div>
      <div class="row-3">
        <div>
          <label>é€¾æ™‚ (æ¯«ç§’, æ¯ç­†)</label>
          <input id="timeoutMs" type="number" min="0" value="10000" />
        </div>
        <div>
          <label>CORS æ¨¡å¼</label>
          <select id="corsMode">
            <option value="cors">cors</option>
            <option value="no-cors">no-cors</option>
            <option value="same-origin">same-origin</option>
          </select>
        </div>
        <div>
          <label>Credentials</label>
          <select id="credentials">
            <option value="omit">omit</option>
            <option value="same-origin">same-origin</option>
            <option value="include">include</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Headers (JSON)</label>
          <textarea id="headers" placeholder='ä¾‹å¦‚ï¼š{"Content-Type":"application/json;charset=UTF-8"}'></textarea>
          <div class="shortcut-row">
            <button type="button" class="secondary btn-compact" onclick="$('#headers').value=JSON.stringify({'Content-Type':'application/json;charset=UTF-8'},null,2)">JSON</button>
            <button type="button" class="secondary btn-compact" onclick="$('#headers').value=JSON.stringify({'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},null,2)">è¡¨å–®</button>
            <button type="button" class="secondary btn-compact" onclick="$('#headers').value=JSON.stringify({'Content-Type':'text/plain;charset=UTF-8'},null,2)">ç´”æ–‡å­—</button>
            <button type="button" class="secondary btn-compact" onclick="$('#headers').value=JSON.stringify({'Content-Type':'application/json;charset=UTF-8','Authorization':'Bearer YOUR_TOKEN'},null,2)">JSON+èªè­‰</button>
            <button type="button" class="secondary btn-compact" onclick="setupCubeTest()">CUBEç³»çµ±</button>
          </div>
        </div>
        <div>
          <label>Bodyï¼ˆæ–‡å­—æˆ– JSONï¼‰</label>
          <textarea id="body" placeholder='POST/PUT/PATCH æ™‚å¯å¡«å¯«'></textarea>
          <div class="shortcut-row">
            <button type="button" class="secondary btn-compact" onclick="$('#body').value=JSON.stringify({message:'æ¸¬è©¦è¨Šæ¯',data:'ç¯„ä¾‹è³‡æ–™'},null,2)">JSON ç¯„ä¾‹</button>
            <button type="button" class="secondary btn-compact" onclick="$('#body').value='key1=value1&key2=value2'">è¡¨å–®ç¯„ä¾‹</button>
            <button type="button" class="secondary btn-compact" onclick="$('#body').value='ç´”æ–‡å­—å…§å®¹æ¸¬è©¦'">ç´”æ–‡å­—ç¯„ä¾‹</button>
          </div>
        </div>
      </div>
      <div class="flex">
        <label class="switch"><input type="checkbox" id="keepAlive"> keepalive</label>
        <label class="switch"><input type="checkbox" id="autoScroll" checked> è‡ªå‹•æ»¾å‹•æ—¥èªŒ</label>
        <label class="switch"><input type="checkbox" id="savePreset" checked> è‡ªå‹•å„²å­˜è¨­å®š</label>
      </div>

      <div class="btns sticky-actions">
        <button id="startBtn">é–‹å§‹å£“æ¸¬</button>
        <button id="stopBtn" class="warn">åœæ­¢</button>
        <button id="singleBtn" class="secondary">å–®ç™¼ä¸€æ¬¡</button>
        <button id="resetBtn" class="secondary">é‡ç½®çµ±è¨ˆ</button>
        <button id="downloadBtn" class="secondary">ä¸‹è¼‰ CSV</button>
        <button onclick="location.reload()" class="secondary">é‡æ–°æ•´ç†</button>
        <button onclick="diagnoseCORS()" class="secondary">CORS è¨ºæ–·</button>
        <button onclick="clearOldSettings()" class="secondary">æ¸…ç†èˆŠè¨­å®š</button>
      </div>

      <div class="divider"></div>
      <h2>å³æ™‚çµ±è¨ˆ</h2>
      <div class="kpi">
        <div class="card"><div class="badge">ç¸½è«‹æ±‚</div><div class="val" id="kTotal">0</div></div>
        <div class="card"><div class="badge">æˆåŠŸ (2xx)</div><div class="val" id="k2xx">0</div></div>
        <div class="card"><div class="badge">å®¢æˆ¶éŒ¯èª¤ (4xx)</div><div class="val" id="k4xx">0</div></div>
        <div class="card"><div class="badge">ä¼ºæœéŒ¯èª¤ (5xx)</div><div class="val" id="k5xx">0</div></div>
        <div class="card"><div class="badge">ç¶²è·¯/å…¶ä»–</div><div class="val" id="kErr">0</div></div>
        <div class="card"><div class="badge">ä½µç™¼æ•¸</div><div class="val" id="kInflight">0</div></div>
      </div>
      <div class="row">
        <div class="card"><div class="badge">p50 å»¶é² (ms)</div><div class="val" id="kP50">-</div></div>
        <div class="card"><div class="badge">p95 å»¶é² (ms)</div><div class="val" id="kP95">-</div></div>
      </div>
      <label>è«‹æ±‚æ—¥èªŒ</label>
      <div id="logs" class="logs" aria-live="polite"></div>
      <div class="footer">æç¤ºï¼šè‹¥å¤§é‡å‡ºç¾ CORS éŒ¯èª¤ï¼Œè«‹ç¢ºèªç›®æ¨™æœå‹™èˆ‡ Actuator å·²é–‹æ”¾è·¨ç¶²åŸŸã€‚<br/>opaque å›æ‡‰ï¼ˆno-corsï¼‰ç„¡æ³•å¾—çŸ¥ç‹€æ…‹ç¢¼ï¼Œå°‡è¢«æ­¸é¡è‡³ã€Œç¶²è·¯/å…¶ä»–ã€ã€‚</div>
    </div>

    <!-- å³ï¼šåœ–è¡¨èˆ‡ Actuator ç›£æ§ -->
    <div class="panel">
      <h2>å³æ™‚åœ–è¡¨</h2>
      <div class="grid2">
        <div>
          <canvas id="rpsChart"></canvas>
        </div>
        <div>
          <canvas id="latChart"></canvas>
        </div>
      </div>

      <div class="divider"></div>
      <h2>Actuator æ–·è·¯å™¨ç›£æ§</h2>
      <div class="row">
        <div>
          <label>Actuator Base URL</label>
          <input id="actuatorBase" placeholder="ä¾‹å¦‚ï¼šhttp://localhost:8080/actuator" />
        </div>
        <div>
          <label>æ–·è·¯å™¨åç¨±ï¼ˆå¯å¤šå€‹ï¼Œä»¥é€—è™Ÿåˆ†éš”ï¼‰</label>
          <input id="cbNames" placeholder="ä¾‹å¦‚ï¼šdemoService" />
        </div>
      </div>
      <div class="row-3">
        <div>
          <label>è¼ªè©¢é–“éš” (ç§’)</label>
          <input id="pollSec" type="number" min="1" value="2" />
        </div>
        <div>
          <label>äº‹ä»¶é¡å‹</label>
          <input id="eventTypes" placeholder="STATE_TRANSITION,ERROR,SUCCESS,IGNORED_ERROR,NOT_PERMITTED" value="STATE_TRANSITION,ERROR" />
        </div>
        <div class="btns">
          <button id="monitorStart">é–‹å§‹ç›£æ§ (GET)</button>
          <button id="monitorStop" class="warn">åœæ­¢ç›£æ§</button>
          <button id="probeCORS" class="secondary">OPTIONS æ¸¬è©¦</button>
          <button onclick="diagnoseActuator()" class="secondary">Actuator è¨ºæ–·</button>
          <button onclick="diagnoseSpecificCB()" class="secondary">æ–·è·¯å™¨è¨ºæ–·</button>
          <button onclick="testCircuitBreakerUpdate()" class="secondary">æ‰‹å‹•æ§åˆ¶ (POST)</button>
        </div>
      </div>

      <div class="grid2">
        <div>
          <div class="badge">æ–·è·¯å™¨ç‹€æ…‹ï¼ˆ0=CLOSED, 1=HALF_OPEN, 2=OPENï¼‰</div>
          <canvas id="cbChart"></canvas>
        </div>
        <div>
          <div class="badge">äº‹ä»¶</div>
          <div class="event-container">
            <table class="table" id="evtTable">
              <thead><tr><th>æ™‚é–“</th><th>åç¨±</th><th>é¡å‹</th><th>ç‹€æ…‹</th><th>è¨Šæ¯</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="divider"></div>
      <h2>å°å¹«æ‰‹</h2>
      <ul>
        <li>è‹¥ç›£æ§å–ä¸åˆ°è³‡æ–™ï¼šè«‹ç¢ºèªå·²åŠ å…¥ <code>management.endpoints.web.exposure.include=circuitbreakers,circuitbreakerevents,metrics</code></li>
        <li>è‹¥ç€è¦½å™¨å ± CORSï¼šæ–¼æ‡‰ç”¨èˆ‡ Actuator è¨­å®šå…è¨±çš„ origins/headers/methods</li>
        <li>RPS æ˜¯è¿‘ä¼¼æ§åˆ¶ï¼›çœŸå¯¦ RPS ä»¥å·¦ä¸Šåœ–ç‚ºæº–</li>
        <li><strong>æ–·è·¯å™¨ç›£æ§èˆ‡æ§åˆ¶èªªæ˜</strong>ï¼š
          <ul>
            <li><strong>ç›£æ§ç‹€æ…‹ (GET)</strong>: <code>/actuator/circuitbreakers</code> - ä¸€æ¬¡å–å¾—æ‰€æœ‰æ–·è·¯å™¨ç‹€æ…‹ï¼Œç”¨æ–¼ç›£æ§</li>
            <li><strong>æ‰‹å‹•æ§åˆ¶ (POST)</strong>: <code>/actuator/circuitbreakers/{name}</code> + <code>{"updateState": "CLOSED|OPEN|HALF_OPEN"}</code> - åƒ…ç”¨æ–¼æ‰‹å‹•å¹²é </li>
            <li>ä¸€èˆ¬ç›£æ§<strong>åªä½¿ç”¨</strong>é€šç”¨ GET endpointï¼Œ<strong>ä¸éœ€è¦</strong>å€‹åˆ¥æ–·è·¯å™¨ç«¯é»</li>
            <li>POST æ§åˆ¶åŠŸèƒ½åƒ…ç”¨æ–¼æ‰‹å‹•ç†”æ–·æˆ–é‡ç½®ï¼Œéç›£æ§ç”¨é€”</li>
          </ul>
        </li>
        <li>Spring Boot 3 + Resilience4j éœ€è¦ä½¿ç”¨ <code>resilience4j-spring-boot3</code> è€Œé <code>resilience4j-spring-boot2</code></li>
      </ul>
    </div>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // THEME
  const themeToggle = $('#themeToggle');
  const applyTheme = () => {
    document.body.setAttribute('data-theme', themeToggle.checked ? 'light' : 'dark');
    localStorage.setItem('cbtool_theme_light', themeToggle.checked ? '1':'0');
  }
  themeToggle.checked = localStorage.getItem('cbtool_theme_light') === '1';
  applyTheme();
  themeToggle.addEventListener('change', applyTheme);

  // ELEMENTS
  const targetUrl = $('#targetUrl');
  const method = $('#method');
  const duration = $('#duration');
  const rps = $('#rps');
  const concurrency = $('#concurrency');
  const timeoutMs = $('#timeoutMs');
  const corsMode = $('#corsMode');
  const credentials = $('#credentials');
  const headers = $('#headers');
  const body = $('#body');
  const keepAlive = $('#keepAlive');
  const autoScroll = $('#autoScroll');
  const savePreset = $('#savePreset');

  const startBtn = $('#startBtn');
  const stopBtn = $('#stopBtn');
  const singleBtn = $('#singleBtn');
  const resetBtn = $('#resetBtn');
  const downloadBtn = $('#downloadBtn');

  const logs = $('#logs');
  const kTotal=$('#kTotal'), k2xx=$('#k2xx'), k4xx=$('#k4xx'), k5xx=$('#k5xx'), kErr=$('#kErr'), kInflight=$('#kInflight');
  const kP50=$('#kP50'), kP95=$('#kP95');

  const actuatorBase = $('#actuatorBase');
  const cbNames = $('#cbNames');
  const pollSec = $('#pollSec');
  const eventTypes = $('#eventTypes');
  const monitorStart = $('#monitorStart');
  const monitorStop = $('#monitorStop');
  const probeCORS = $('#probeCORS');

  // State
  let run = { active:false, endAt:0, inFlight:0, permit:0, tickHandle:null, stopSignal:false };
  let stats = { total:0, s2xx:0, s4xx:0, s5xx:0, err:0, lat:[], lastSecond:{count:0, sumLat:0}, buckets:[] };
  let points = { rps:[], lat:[] };
  let monitors = { timer:null, series:{}, events:[] };

  // Load preset
  (function loadPreset(){
    try{
      const raw = localStorage.getItem('cbtool_preset');
      if(!raw) return;
      const p = JSON.parse(raw);
      // ä¿®æ­£èˆŠçš„æ–·è·¯å™¨åç¨±
      if(p.cbNames === 'queryHexDeviceId') {
        p.cbNames = 'testBizServer';
        log('ğŸ”§ è‡ªå‹•æ›´æ–°èˆŠçš„æ–·è·¯å™¨åç¨±: queryHexDeviceId â†’ testBizServer');
      }
      for(const [k,v] of Object.entries(p)){
        const el = {
          targetUrl, method, duration, rps, concurrency, timeoutMs, corsMode, credentials, headers, body, keepAlive, autoScroll, savePreset,
          actuatorBase, cbNames, pollSec, eventTypes
        }[k];
        if(!el) continue;
        if(el.type === 'checkbox') el.checked = !!v; else el.value = v;
      }
    }catch(e){ console.warn('Preset load fail', e); }
  })();

  function remember(){
    if(!savePreset.checked) return;
    const data = {
      targetUrl:targetUrl.value, method:method.value, duration:duration.value, rps:rps.value, concurrency:concurrency.value,
      timeoutMs:timeoutMs.value, corsMode:corsMode.value, credentials:credentials.value, headers:headers.value, body:body.value,
      keepAlive:keepAlive.checked, autoScroll:autoScroll.checked, savePreset:savePreset.checked,
      actuatorBase:actuatorBase.value, cbNames:cbNames.value, pollSec:pollSec.value, eventTypes:eventTypes.value
    };
    localStorage.setItem('cbtool_preset', JSON.stringify(data));
  }
  $$('.panel input, .panel select, .panel textarea').forEach(el=>{
    el.addEventListener('change', remember);
    el.addEventListener('blur', remember);
  })

  function log(line){
    const ts = new Date().toISOString().replace('T',' ').replace('Z','');
    logs.textContent += `[${ts}] ${line}\n`;
    if(autoScroll.checked) logs.scrollTop = logs.scrollHeight;
  }

  function percentile(arr, p){
    if(!arr.length) return NaN;
    const a = [...arr].sort((x,y)=>x-y);
    const idx = Math.floor((p/100) * (a.length-1));
    return a[idx];
  }

  // Charts setup
  const rpsChart = new Chart($('#rpsChart'), {
    type:'line',
    data:{datasets:[
      {label:'å¯¦éš› RPS', data:[], parsing:false, borderWidth:2, pointRadius:0, tension:0.15},
      {label:'å¹³å‡å»¶é² (ms)', data:[], yAxisID:'y1', parsing:false, borderWidth:2, pointRadius:0, tension:0.15}
    ]},
    options:{
      animation:false,
      normalized:true,
      scales:{
        x:{type:'time', time:{unit:'second'}},
        y:{title:{text:'RPS', display:true}, beginAtZero:true},
        y1:{position:'right', title:{text:'Latency (ms)', display:true}, beginAtZero:true}
      },
      plugins:{legend:{display:true}}
    }
  });

  const latChart = new Chart($('#latChart'), {
    type:'line',
    data:{datasets:[{label:'å»¶é² p50', data:[], borderWidth:2, pointRadius:0}, {label:'å»¶é² p95', data:[], borderWidth:2, pointRadius:0}]},
    options:{animation:false, normalized:true, scales:{x:{type:'time', time:{unit:'second'}}, y:{beginAtZero:true, title:{text:'ms', display:true}}}}
  });

  const cbChart = new Chart($('#cbChart'), {
    type:'line',
    data:{datasets:[]},
    options:{
      animation:false,
      scales:{x:{type:'time', time:{unit:'second'}}, y:{beginAtZero:true, suggestedMax:2, ticks:{stepSize:1}},},
      plugins:{legend:{display:true}},
      elements:{line:{stepped:true}, point:{radius:0}}
    }
  });

  function updateKPI(){
    kTotal.textContent = stats.total;
    k2xx.textContent = stats.s2xx;
    k4xx.textContent = stats.s4xx;
    k5xx.textContent = stats.s5xx;
    kErr.textContent = stats.err;
    kInflight.textContent = run.inFlight;
    const p50 = percentile(stats.lat, 50);
    const p95 = percentile(stats.lat, 95);
    kP50.textContent = isNaN(p50)? '-' : Math.round(p50);
    kP95.textContent = isNaN(p95)? '-' : Math.round(p95);
  }

  function pushCharts(now){
    // push once per second for RPS + avg latency
    const ts = now ?? Date.now();
    const rpsVal = stats.lastSecond.count;
    const avgLat = stats.lastSecond.count ? (stats.lastSecond.sumLat / stats.lastSecond.count) : 0;
    rpsChart.data.datasets[0].data.push({x:ts, y:rpsVal});
    rpsChart.data.datasets[1].data.push({x:ts, y:Math.round(avgLat)});
    rpsChart.update('none');

    // p50, p95 line (snapshot)
    const p50 = percentile(stats.lat, 50);
    const p95 = percentile(stats.lat, 95);
    if(!isNaN(p50)) latChart.data.datasets[0].data.push({x:ts, y:Math.round(p50)});
    if(!isNaN(p95)) latChart.data.datasets[1].data.push({x:ts, y:Math.round(p95)});
    latChart.update('none');

    // reset window
    stats.lastSecond = {count:0, sumLat:0};
  }

  setInterval(()=>{ // chart heartbeat each second
    pushCharts();
  }, 1000);

  async function doFetchOnce(){
    const url = targetUrl.value.trim();
    if(!url){ log('â— è«‹è¼¸å…¥ç›®æ¨™ URL'); return; }
    let hdr = {};
    if(headers.value.trim()){
      try{ hdr = JSON.parse(headers.value); }
      catch(e){ log('â— Headers ä¸æ˜¯åˆæ³• JSON'); return; }
    }
    
    // åµéŒ¯ï¼šé¡¯ç¤ºå¯¦éš›ç™¼é€çš„ Headers
    log(`ğŸ” ç™¼é€è«‹æ±‚åˆ°: ${url}`);
    log(`ğŸ” HTTP æ–¹æ³•: ${method.value}`);
    log(`ğŸ” Headers: ${JSON.stringify(hdr)}`);
    if(body.value && !['GET','HEAD','OPTIONS'].includes(method.value)){
      log(`ğŸ” Body: ${body.value.substring(0, 100)}${body.value.length > 100 ? '...' : ''}`);
    }
    
    const ctrl = new AbortController();
    const to = Number(timeoutMs.value||0);
    const tId = to>0 ? setTimeout(()=>ctrl.abort('timeout'), to) : null;
    const started = performance.now();
    try{
      const res = await fetch(url, {
        method: method.value,
        headers: hdr,
        body: ['GET','HEAD','OPTIONS'].includes(method.value)? undefined : body.value,
        mode: corsMode.value,
        credentials: credentials.value,
        keepalive: keepAlive.checked,
        signal: ctrl.signal,
      });
      const elapsed = performance.now()-started;
      const st = res.status || 0;
      classify(st, elapsed);
      log(`â† ${st} ${Math.round(elapsed)}ms`);
      // best-effort read (opaque ç„¡æ³•è®€)
      try{ await res.text(); }catch(_){/* ignore */}
    }catch(err){
      const elapsed = performance.now()-started;
      stats.err++; stats.total++; stats.lat.push(elapsed); stats.lastSecond.count++; stats.lastSecond.sumLat+=elapsed; updateKPI();
      log(`Ã— ${err?.name||'Error'} ${Math.round(elapsed)}ms`);
    }finally{
      if(tId) clearTimeout(tId);
    }
  }

  function classify(status, elapsed){
    stats.total++;
    stats.lat.push(elapsed);
    stats.lastSecond.count++;
    stats.lastSecond.sumLat += elapsed;
    if(status>=200 && status<300) stats.s2xx++;
    else if(status>=400 && status<500) stats.s4xx++;
    else if(status>=500 && status<600) stats.s5xx++;
    else stats.err++; // åŒ…å« 0 (opaque / CORS è¢«æ“‹ / ç¶²è·¯)
    updateKPI();
  }

  function resetStats(){
    stats = { total:0, s2xx:0, s4xx:0, s5xx:0, err:0, lat:[], lastSecond:{count:0,sumLat:0}, buckets:[] };
    rpsChart.data.datasets.forEach(d=>d.data.length=0);
    latChart.data.datasets.forEach(d=>d.data.length=0);
    rpsChart.update('none');
    latChart.update('none');
    updateKPI();
    logs.textContent = '';
  }

  // Scheduler: 100ms tick, token bucket to approximate RPS; respects max concurrency
  function startRun(){
    if(run.active){ log('å·²åœ¨åŸ·è¡Œ'); return; }
    const sec = Math.max(1, Number(duration.value||0));
    const wantRps = Math.max(0, Number(rps.value||0));
    const maxConc = Math.max(1, Number(concurrency.value||1));
    run.active = true; run.stopSignal = false; run.inFlight = 0; run.permit = 0; run.endAt = Date.now() + sec*1000;
    log(`â–¶ é–‹å§‹ï¼š${sec}s, ç›®æ¨™ RPS=${wantRps}, æœ€å¤§ä¸¦è¡Œ=${maxConc}`);

    const tickInterval = 100; // ms
    const perTick = wantRps * (tickInterval/1000);

    run.tickHandle = setInterval(async ()=>{
      if(run.stopSignal || Date.now() >= run.endAt){ stopRun(); return; }
      run.permit += perTick;
      while(run.permit >= 1 && run.inFlight < maxConc){
        run.permit -= 1; run.inFlight++; updateKPI();
        doFetchOnce().finally(()=>{ run.inFlight--; updateKPI(); });
      }
    }, tickInterval);
  }

  function stopRun(){
    if(run.tickHandle) clearInterval(run.tickHandle);
    run.tickHandle = null; run.active=false; run.stopSignal=true; log('â–  åœæ­¢');
  }

  // Buttons
  startBtn.addEventListener('click', startRun);
  stopBtn.addEventListener('click', ()=>{ run.stopSignal=true; stopRun(); });
  resetBtn.addEventListener('click', resetStats);
  singleBtn.addEventListener('click', ()=>{ run.inFlight++; updateKPI(); doFetchOnce().finally(()=>{ run.inFlight--; updateKPI(); }); });
  downloadBtn.addEventListener('click', ()=>{
    const rows = [
      ['total','2xx','4xx','5xx','errors','p50(ms)','p95(ms)'],
      [stats.total, stats.s2xx, stats.s4xx, stats.s5xx, stats.err, Math.round(percentile(stats.lat,50)||0), Math.round(percentile(stats.lat,95)||0)]
    ];
    const csv = rows.map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'cbtool_stats.csv';
    a.click();
  });

  // --- Actuator monitoring ---
  function stateToNum(s){ return s==='CLOSED'?0 : s==='HALF_OPEN'?1 : s==='OPEN'?2 : null; }

  function ensureCBSeries(names){
    const list = names.split(',').map(s=>s.trim()).filter(Boolean);
    list.forEach(n=>{
      if(!monitors.series[n]){
        monitors.series[n] = [];
        cbChart.data.datasets.push({label:n, data:[], parsing:false, borderWidth:2, stepped:true, pointRadius:0});
      }
    });
    // prune datasets not in list
    cbChart.data.datasets = cbChart.data.datasets.filter(ds=>list.includes(ds.label));
  }

  async function fetchAllCBStates(base){
    // åªä½¿ç”¨é€šç”¨ç«¯é»å–å¾—æ‰€æœ‰æ–·è·¯å™¨ç‹€æ…‹
    try{
      const res = await fetch(`${base.replace(/\/$/,'')}/circuitbreakers`, {mode:corsMode.value, credentials:credentials.value});
      if(res.ok){
        const js = await res.json();
        // æ ¹æ“šä½ æä¾›çš„æ ¼å¼: { "circuitBreakers": { "name": { "state": "CLOSED", ... }, ... } }
        return js.circuitBreakers || {};
      }
    }catch(_){/* ignore */}
    return {};
  }

  async function fetchCBEventsOnce(base, names, types){
    const list = names.split(',').map(s=>s.trim()).filter(Boolean);
    const out = [];
    for(const n of list){
      try{
        const url = `${base.replace(/\/$/,'')}/circuitbreakerevents/${encodeURIComponent(n)}?type=${encodeURIComponent(types)}`;
        const res = await fetch(url, {mode:corsMode.value, credentials:credentials.value});
        if(!res.ok) continue;
        const js = await res.json();
        const events = js?.circuitBreakerEvents || js?.events || js || [];
        events.forEach(ev=>{
          out.push({ time: ev?.creationTime || ev?.timestamp || ev?.time || new Date().toISOString(), name: n, type: ev?.type, state: ev?.stateTransition || ev?.state || '', message: ev?.errorMessage || ev?.message || '' });
        });
      }catch(_){/* ignore */}
    }
    return out.sort((a,b)=>new Date(a.time)-new Date(b.time));
  }

  function updateEvtTable(){
    const tbody = $('#evtTable tbody');
    const container = document.querySelector('.event-container');
    tbody.innerHTML = '';
    const recent = monitors.events.slice(-200);
    for(const e of recent){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(e.time).toLocaleTimeString()}</td><td>${e.name}</td><td>${e.type||''}</td><td>${e.state||''}</td><td>${(e.message||'').toString().slice(0,120)}</td>`;
      tbody.appendChild(tr);
    }
    // è‡ªå‹•æ²å‹•åˆ°æœ€æ–°äº‹ä»¶
    if(container && autoScroll.checked) {
      setTimeout(() => container.scrollTop = container.scrollHeight, 0);
    }
  }

  function startMonitor(){
    if(monitors.timer) return;
    const base = actuatorBase.value.trim();
    const names = cbNames.value.trim();
    if(!base || !names){ log('â— è«‹è¨­å®š Actuator Base èˆ‡ æ–·è·¯å™¨åç¨±'); return; }
    ensureCBSeries(names);
    const tick = async ()=>{
      const now = Date.now();
      // ä¸€æ¬¡æ€§å–å¾—æ‰€æœ‰æ–·è·¯å™¨ç‹€æ…‹
      const allCBStates = await fetchAllCBStates(base);
      const wantedNames = names.split(',').map(s=>s.trim()).filter(Boolean);
      
      for(const n of wantedNames){
        const cbData = allCBStates[n];
        if(cbData && cbData.state){
          const y = stateToNum(cbData.state);
          const ds = cbChart.data.datasets.find(d=>d.label===n);
          if(ds && y!=null){ ds.data.push({x:now, y}); }
        }
      }
      cbChart.update('none');

      // events
      const evs = await fetchCBEventsOnce(base, names, eventTypes.value||'');
      if(evs.length){ monitors.events = evs; updateEvtTable(); }
    }
    tick();
    monitors.timer = setInterval(tick, Math.max(1, Number(pollSec.value||2))*1000);
    log(`ğŸŸ¢ ç›£æ§é–‹å§‹ï¼Œæ¯ ${pollSec.value}s è¼ªè©¢`);
  }

  function stopMonitor(){ if(monitors.timer){ clearInterval(monitors.timer); monitors.timer=null; log('ğŸŸ¡ ç›£æ§åœæ­¢'); } }

  monitorStart.addEventListener('click', startMonitor);
  monitorStop.addEventListener('click', stopMonitor);

  probeCORS.addEventListener('click', async ()=>{
    const url = actuatorBase.value.replace(/\/$/,'') + '/circuitbreakers';
    try{
      const res = await fetch(url, { method:'OPTIONS', mode:corsMode.value, credentials:credentials.value });
      log(`CORS é æª¢ OPTIONS â†’ ç‹€æ…‹=${res.status||0}`);
    }catch(e){ log('CORS é æª¢å¤±æ•—ï¼š'+ e); }
  });

  // CUBE ç³»çµ±æ¸¬è©¦è¨­å®š
  window.setupCubeTest = function() {
    targetUrl.value = 'http://localhost:10071/txn/MFTTX101/010';
    method.value = 'POST';
    headers.value = JSON.stringify({
      'Content-Type': 'application/json;charset=UTF-8'
    }, null, 2);
    body.value = JSON.stringify({
      header: {
        txnCode: 'MFTTX101',
        channelId: '010',
        userId: 'TEST_USER',
        timestamp: new Date().toISOString()
      },
      body: {
        testData: 'æ¸¬è©¦è³‡æ–™',
        message: 'æ–·è·¯å™¨å£“æ¸¬'
      }
    }, null, 2);
    actuatorBase.value = 'http://localhost:10071/actuator';
    cbNames.value = 'testBizServer';
    log('ğŸ”§ å·²è¨­å®š CUBE ç³»çµ±æ¸¬è©¦åƒæ•¸');
    // ç«‹å³å„²å­˜æ–°çš„è¨­å®š
    remember();
  };

  // CORS è¨ºæ–·åŠŸèƒ½
  window.diagnoseCORS = async function() {
    const url = targetUrl.value.trim() || 'http://localhost:10071/txn/MFTTX101/010';
    log('ğŸ” é–‹å§‹ CORS è¨ºæ–·...');
    
    // 1. æ¸¬è©¦ OPTIONS é æª¢
    try {
      log(`ğŸ” æ¸¬è©¦ OPTIONS é æª¢: ${url}`);
      const optionsRes = await fetch(url, {
        method: 'OPTIONS',
        headers: {
          'Origin': window.location.origin,
          'Access-Control-Request-Method': 'POST',
          'Access-Control-Request-Headers': 'Content-Type'
        },
        mode: 'cors'
      });
      log(`âœ… OPTIONS å›æ‡‰: ${optionsRes.status} ${optionsRes.statusText}`);
      
      // æª¢æŸ¥å›æ‡‰æ¨™é ­
      const allowOrigin = optionsRes.headers.get('Access-Control-Allow-Origin');
      const allowMethods = optionsRes.headers.get('Access-Control-Allow-Methods');
      const allowHeaders = optionsRes.headers.get('Access-Control-Allow-Headers');
      const allowCredentials = optionsRes.headers.get('Access-Control-Allow-Credentials');
      
      log(`ğŸ” Access-Control-Allow-Origin: ${allowOrigin || 'âŒ æœªè¨­å®š'}`);
      log(`ğŸ” Access-Control-Allow-Methods: ${allowMethods || 'âŒ æœªè¨­å®š'}`);
      log(`ğŸ” Access-Control-Allow-Headers: ${allowHeaders || 'âŒ æœªè¨­å®š'}`);
      log(`ğŸ” Access-Control-Allow-Credentials: ${allowCredentials || 'âŒ æœªè¨­å®š'}`);
      
      if (optionsRes.status === 403) {
        log('âŒ CORS é æª¢è¢«æ‹’çµ•ï¼å¯èƒ½åŸå› ï¼š');
        log('  1. Spring Security é˜»æ­¢äº† OPTIONS è«‹æ±‚');
        log('  2. CORS è¨­å®šæœªæ­£ç¢ºç”Ÿæ•ˆ');
        log('  3. éœ€è¦åœ¨ Security è¨­å®šä¸­å…è¨± OPTIONS');
      }
      
    } catch (err) {
      log(`âŒ OPTIONS å¤±æ•—: ${err.message}`);
    }
    
    // 2. æ¸¬è©¦ç°¡å–®çš„ GET è«‹æ±‚
    try {
      log(`ğŸ” æ¸¬è©¦ç°¡å–® GET è«‹æ±‚...`);
      const getRes = await fetch(url.replace('POST', 'GET'), {
        method: 'GET',
        mode: 'cors'
      });
      log(`âœ… GET è«‹æ±‚: ${getRes.status}`);
    } catch (err) {
      log(`âŒ GET è«‹æ±‚å¤±æ•—: ${err.message}`);
    }
    
    // 3. æ¸¬è©¦ no-cors æ¨¡å¼
    try {
      log(`ğŸ” æ¸¬è©¦ no-cors æ¨¡å¼...`);
      const noCorsRes = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: '{"test": "no-cors"}',
        mode: 'no-cors'
      });
      log(`âœ… no-cors æ¨¡å¼æˆåŠŸ (opaque response)`);
    } catch (err) {
      log(`âŒ no-cors æ¨¡å¼å¤±æ•—: ${err.message}`);
    }
    
    // 4. å»ºè­°è§£æ±ºæ–¹æ¡ˆ
    log('ğŸ“‹ CORS è¨ºæ–·å®Œæˆï¼è§£æ±ºæ–¹æ¡ˆï¼š');
    log('ğŸ’¡ 1. ç¢ºèª Spring Security è¨­å®šï¼š');
    log('   @Bean');
    log('   public SecurityFilterChain filterChain(HttpSecurity http) {');
    log('     return http.cors().and()');
    log('       .authorizeHttpRequests(auth -> auth');
    log('         .requestMatchers(HttpMethod.OPTIONS, "/**").permitAll()');
    log('         .anyRequest().permitAll())');
    log('       .csrf().disable().build();');
    log('   }');
    log('ğŸ’¡ 2. ç¢ºèª CorsConfiguration ä¸­ä½¿ç”¨ setAllowedOriginPatterns("*")');
    log('ğŸ’¡ 3. é‡å•Ÿæ‡‰ç”¨ç¨‹å¼ç¢ºä¿è¨­å®šç”Ÿæ•ˆ');
  };

  // Actuator è¨ºæ–·åŠŸèƒ½
  window.diagnoseActuator = async function() {
    const base = actuatorBase.value.trim() || 'http://localhost:10071/actuator';
    log('ğŸ” é–‹å§‹ Actuator è¨ºæ–·...');
    
    // å…ˆæ¸¬è©¦åŸºæœ¬é€£ç·š
    try {
      log(`ğŸ” æ¸¬è©¦åŸºæœ¬é€£ç·š: ${base}/health`);
      const basicRes = await fetch(`${base}/health`, {
        method: 'GET',
        mode: 'no-cors'  // å…ˆç”¨ no-cors æ¸¬è©¦é€£ç·š
      });
      log(`âœ… no-cors æ¨¡å¼é€£ç·šæˆåŠŸ`);
    } catch (err) {
      log(`âŒ åŸºæœ¬é€£ç·šå¤±æ•—: ${err.message}`);
      log(`ğŸ’¡ å¯èƒ½åŸå› : Actuator æœªå•Ÿå‹•æˆ–ç«¯å£éŒ¯èª¤`);
    }
    
    // æ¸¬è©¦ OPTIONS é æª¢
    try {
      log(`ğŸ” æ¸¬è©¦ Actuator OPTIONS é æª¢...`);
      const optionsRes = await fetch(`${base}/health`, {
        method: 'OPTIONS',
        headers: {
          'Origin': window.location.origin,
          'Access-Control-Request-Method': 'GET',
          'Access-Control-Request-Headers': 'Content-Type'
        },
        mode: 'cors'
      });
      log(`âœ… OPTIONS é æª¢: ${optionsRes.status} ${optionsRes.statusText}`);
      
      // æª¢æŸ¥ CORS æ¨™é ­
      const allowOrigin = optionsRes.headers.get('Access-Control-Allow-Origin');
      const allowMethods = optionsRes.headers.get('Access-Control-Allow-Methods');
      log(`ğŸ” Actuator Allow-Origin: ${allowOrigin || 'âŒ æœªè¨­å®š'}`);
      log(`ğŸ” Actuator Allow-Methods: ${allowMethods || 'âŒ æœªè¨­å®š'}`);
      
    } catch (err) {
      log(`âŒ Actuator OPTIONS å¤±æ•—: ${err.message}`);
      log(`ğŸ’¡ Actuator CORS æœªæ­£ç¢ºè¨­å®š`);
    }
    
    // æ¸¬è©¦å„ç¨® Actuator ç«¯é» (ä½¿ç”¨ cors æ¨¡å¼)
    const endpoints = [
      '/health',
      '/info', 
      '/circuitbreakers',
      '/circuitbreakerevents'
    ];
    
    for (const endpoint of endpoints) {
      const url = base + endpoint;
      try {
        log(`ğŸ” æ¸¬è©¦ç«¯é» (cors): ${url}`);
        const res = await fetch(url, {
          method: 'GET',
          mode: 'cors',
          credentials: 'omit'
        });
        
        if (res.ok) {
          log(`âœ… ${endpoint}: ${res.status} OK`);
          if (endpoint === '/circuitbreakers') {
            try {
              const data = await res.json();
              log(`ğŸ” æ–·è·¯å™¨è³‡æ–™: ${JSON.stringify(data).substring(0, 100)}...`);
            } catch (e) {
              log(`âš ï¸ ç„¡æ³•è§£æ JSON: ${e.message}`);
            }
          }
        } else {
          log(`âŒ ${endpoint}: ${res.status} ${res.statusText}`);
        }
      } catch (err) {
        log(`âŒ ${endpoint}: ${err.message}`);
      }
    }
    
    log('ğŸ“‹ Actuator è¨ºæ–·å®Œæˆï¼æ ¹æ“šçµæœï¼š');
    
    log('ğŸ’¡ 1. å¦‚æœæ‰€æœ‰è«‹æ±‚éƒ½ "Failed to fetch"ï¼š');
    log('   - æª¢æŸ¥ Spring Boot æ‡‰ç”¨ç¨‹å¼æ˜¯å¦åœ¨ port 10071 åŸ·è¡Œ');
    log('   - åœ¨ç€è¦½å™¨ç›´æ¥è¨ªå•: http://localhost:10071/actuator/health');
    log('   - æª¢æŸ¥é˜²ç«ç‰†æˆ–ä»£ç†è¨­å®š');
    log('');
    
    log('ğŸ’¡ 2. å¦‚æœæ˜¯ CORS å•é¡Œï¼Œåœ¨ application.yml åŠ å…¥ï¼š');
    log('   management:');
    log('     endpoints:');
    log('       web:');
    log('         exposure:');
    log('           include: "health,info,metrics,circuitbreakers,circuitbreakerevents"');
    log('         cors:');
    log('           allowed-origins: "*"');
    log('           allowed-methods: "GET,POST,OPTIONS"');
    log('           allowed-headers: "*"');
    log('');
    
    log('ğŸ’¡ 3. Security è¨­å®šä¸­åŠ å…¥ï¼š');
    log('   .requestMatchers("/actuator/**").permitAll()');
    log('');
    
    log('ğŸ’¡ 4. æš«æ™‚æ¸¬è©¦æ–¹æ³•ï¼š');
    log('   - å°‡æ¸¬è©¦å·¥å…· CORS æ¨¡å¼æ”¹ç‚º "no-cors"');
    log('   - æˆ–åœ¨æ–°åˆ†é ç›´æ¥è¨ªå• Actuator ç«¯é»');
  };

  // ç‰¹å®šæ–·è·¯å™¨è¨ºæ–·åŠŸèƒ½
  window.diagnoseSpecificCB = async function() {
    const base = actuatorBase.value.trim() || 'http://localhost:10071/actuator';
    const cbName = cbNames.value.trim() || 'testBizServer';
    log('ğŸ” é–‹å§‹ç‰¹å®šæ–·è·¯å™¨è¨ºæ–·...');
    log(`ğŸ” æ–·è·¯å™¨åç¨±: ${cbName}`);
    log('ğŸ’¡ åªä½¿ç”¨é€šç”¨ç«¯é»: /actuator/circuitbreakers');
    
    // æ¸¬è©¦é€šç”¨æ–·è·¯å™¨åˆ—è¡¨ç«¯é»
    try {
      log(`ğŸ” æ¸¬è©¦æ–·è·¯å™¨åˆ—è¡¨: ${base}/circuitbreakers`);
      const listRes = await fetch(`${base}/circuitbreakers`, {
        method: 'GET',
        mode: 'cors',
        credentials: 'omit'
      });
      
      if (listRes.ok) {
        const data = await listRes.json();
        log(`âœ… æ–·è·¯å™¨åˆ—è¡¨æˆåŠŸ: ${listRes.status}`);
        
        // æ ¹æ“šä½ æä¾›çš„æ ¼å¼æª¢æŸ¥ circuitBreakers ç‰©ä»¶
        const circuitBreakers = data.circuitBreakers || {};
        const availableNames = Object.keys(circuitBreakers);
        log(`ğŸ” å¯ç”¨çš„æ–·è·¯å™¨: ${JSON.stringify(availableNames, null, 2)}`);
        
        // æª¢æŸ¥ç›®æ¨™æ–·è·¯å™¨æ˜¯å¦å­˜åœ¨
        if (circuitBreakers[cbName]) {
          log(`âœ… æ‰¾åˆ°æ–·è·¯å™¨ "${cbName}"`);
          log(`ğŸ” å®Œæ•´ç‹€æ…‹è³‡è¨Š: ${JSON.stringify(circuitBreakers[cbName], null, 2)}`);
          
          const cbInfo = circuitBreakers[cbName];
          log(`ï¿½ é—œéµè³‡è¨Š:`);
          log(`   ç‹€æ…‹: ${cbInfo.state}`);
          log(`   å¤±æ•—ç‡: ${cbInfo.failureRate}`);
          log(`   æ…¢å‘¼å«ç‡: ${cbInfo.slowCallRate}`);
          log(`   ç·©è¡å‘¼å«æ•¸: ${cbInfo.bufferedCalls}`);
          log(`   å¤±æ•—å‘¼å«æ•¸: ${cbInfo.failedCalls}`);
          log(`   ä¸è¢«å…è¨±çš„å‘¼å«æ•¸: ${cbInfo.notPermittedCalls}`);
        } else {
          log(`âŒ æ–·è·¯å™¨ "${cbName}" ä¸å­˜åœ¨`);
          log(`ï¿½ å¯ç”¨çš„æ–·è·¯å™¨åç¨±: ${availableNames.join(', ')}`);
        }
      } else {
        log(`âŒ æ–·è·¯å™¨åˆ—è¡¨å¤±æ•—: ${listRes.status} ${listRes.statusText}`);
      }
    } catch (err) {
      log(`âŒ æ–·è·¯å™¨åˆ—è¡¨éŒ¯èª¤: ${err.message}`);
      if (err.message.includes('CORS')) {
        log(`ğŸ’¡ CORS éŒ¯èª¤è§£æ±ºæ–¹æ¡ˆ:`);
        log(`   1. ç¢ºèª management.endpoints.web.cors è¨­å®šæ­£ç¢º`);
        log(`   2. åœ¨ Security ä¸­å…è¨±: .requestMatchers("/actuator/**").permitAll()`);
      }
    }
    
    log('ï¿½ æ–·è·¯å™¨è¨ºæ–·å®Œæˆï¼');
    log('ğŸ’¡ æé†’: ç›£æ§åªä½¿ç”¨ /actuator/circuitbreakersï¼Œä¸éœ€è¦å€‹åˆ¥æ–·è·¯å™¨ç«¯é»');
  };

  // æ¸¬è©¦æ–·è·¯å™¨ç‹€æ…‹æ›´æ–°åŠŸèƒ½ (åƒ…ç”¨æ–¼æ‰‹å‹•æ§åˆ¶ï¼Œç›£æ§ä¸éœ€è¦)
  window.testCircuitBreakerUpdate = async function() {
    const base = actuatorBase.value.trim() || 'http://localhost:10071/actuator';
    const cbName = cbNames.value.trim() || 'testBizServer';
    log('ğŸ”§ é–‹å§‹æ¸¬è©¦æ–·è·¯å™¨ç‹€æ…‹æ›´æ–°...');
    log(`ğŸ”§ æ–·è·¯å™¨åç¨±: ${cbName}`);
    log('âš ï¸ æ³¨æ„: æ­¤åŠŸèƒ½åƒ…ç”¨æ–¼æ‰‹å‹•æ§åˆ¶æ–·è·¯å™¨ï¼Œä¸€èˆ¬ç›£æ§åªä½¿ç”¨ /actuator/circuitbreakers');
    
    const updateUrl = `${base}/circuitbreakers/${encodeURIComponent(cbName)}`;
    const states = ['CLOSED', 'OPEN', 'HALF_OPEN'];
    
    // 1. å…ˆå¾é€šç”¨ç«¯é»å–å¾—ç›®å‰ç‹€æ…‹
    try {
      log(`ğŸ” å¾é€šç”¨ç«¯é»å–å¾—ç›®å‰æ–·è·¯å™¨ç‹€æ…‹...`);
      const listRes = await fetch(`${base}/circuitbreakers`, {
        method: 'GET',
        mode: 'cors',
        credentials: 'omit'
      });
      
      if (listRes.ok) {
        const listData = await listRes.json();
        const currentCB = listData.circuitBreakers?.[cbName];
        if (currentCB) {
          log(`âœ… ç›®å‰ç‹€æ…‹: ${JSON.stringify(currentCB, null, 2)}`);
        } else {
          log(`âŒ åœ¨é€šç”¨ç«¯é»ä¸­æ‰¾ä¸åˆ°æ–·è·¯å™¨ "${cbName}"`);
        }
      } else {
        log(`âŒ ç„¡æ³•å¾é€šç”¨ç«¯é»å–å¾—ç‹€æ…‹: ${listRes.status} ${listRes.statusText}`);
      }
    } catch (err) {
      log(`âŒ å–å¾—ç›®å‰ç‹€æ…‹å¤±æ•—: ${err.message}`);
    }
    
    // 2. æ¸¬è©¦å„ç¨®ç‹€æ…‹æ›´æ–°
    for (const state of states) {
      try {
        log(`ğŸ”§ å˜—è©¦å°‡æ–·è·¯å™¨ç‹€æ…‹æ›´æ–°ç‚º: ${state}`);
        
        const updateRes = await fetch(updateUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ updateState: state }),
          mode: 'cors',
          credentials: 'omit'
        });
        
        if (updateRes.ok) {
          const responseData = await updateRes.json();
          log(`âœ… æˆåŠŸæ›´æ–°æ–·è·¯å™¨ç‹€æ…‹ç‚º ${state}: ${updateRes.status}`);
          log(`ğŸ” å›æ‡‰è³‡æ–™: ${JSON.stringify(responseData, null, 2)}`);
        } else {
          const errorText = await updateRes.text();
          log(`âŒ æ›´æ–°ç‹€æ…‹ç‚º ${state} å¤±æ•—: ${updateRes.status} ${updateRes.statusText}`);
          log(`ğŸ” éŒ¯èª¤å…§å®¹: ${errorText}`);
          
          if (updateRes.status === 400) {
            log(`ğŸ’¡ 400éŒ¯èª¤é€šå¸¸è¡¨ç¤ºåƒæ•¸æ ¼å¼éŒ¯èª¤æˆ–ç¼ºå°‘å¿…è¦åƒæ•¸`);
            log(`ğŸ’¡ ç¢ºèªè«‹æ±‚ Body: ${JSON.stringify({ updateState: state })}`);
          }
        }
        
        // ç­‰å¾…ä¸€æ®µæ™‚é–“è®“ç‹€æ…‹è®Šæ›´ç”Ÿæ•ˆ
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // é©—è­‰ç‹€æ…‹æ˜¯å¦çœŸçš„æ›´æ–°äº†
        try {
          const verifyRes = await fetch(updateUrl, {
            method: 'GET',
            mode: 'cors',
            credentials: 'omit'
          });
          
          if (verifyRes.ok) {
            const verifyData = await verifyRes.json();
            log(`ğŸ” é©—è­‰æ›´æ–°å¾Œç‹€æ…‹: ${JSON.stringify(verifyData, null, 2)}`);
          }
        } catch (verifyErr) {
          log(`âš ï¸ é©—è­‰ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ${verifyErr.message}`);
        }
        
      } catch (err) {
        log(`âŒ æ›´æ–°ç‹€æ…‹ ${state} æ™‚ç™¼ç”ŸéŒ¯èª¤: ${err.message}`);
        
        if (err.message.includes('CORS')) {
          log(`ğŸ’¡ CORS éŒ¯èª¤è§£æ±ºæ–¹æ¡ˆ:`);
          log(`   1. ç¢ºèª management.endpoints.web.cors.allowed-methods åŒ…å« POST`);
          log(`   2. ç¢ºèª management.endpoints.web.cors.allowed-headers åŒ…å« Content-Type`);
          log(`   3. æª¢æŸ¥ Spring Security æ˜¯å¦å…è¨± POST /actuator/circuitbreakers/**`);
        }
      }
    }
    
    log('ğŸ“‹ æ–·è·¯å™¨ç‹€æ…‹æ›´æ–°æ¸¬è©¦å®Œæˆï¼');
    log('ğŸ’¡ æ­£ç¢ºçš„ POST è«‹æ±‚æ ¼å¼ï¼š');
    log(`   URL: ${updateUrl}`);
    log(`   Method: POST`);
    log(`   Headers: { "Content-Type": "application/json" }`);
    log(`   Body: { "updateState": "CLOSED|OPEN|HALF_OPEN" }`);
  };

  // æ¸…ç†èˆŠè¨­å®šåŠŸèƒ½
  window.clearOldSettings = function() {
    try {
      localStorage.removeItem('cbtool_preset');
      cbNames.value = 'testBizServer';
      actuatorBase.value = 'http://localhost:10071/actuator';
      log('ğŸ§¹ å·²æ¸…ç†èˆŠçš„ç€è¦½å™¨è¨­å®šï¼Œä¸¦é‡è¨­ç‚ºæ¨è–¦å€¼');
      log('ğŸ’¡ å»ºè­°é»æ“Š "CUBEç³»çµ±" æŒ‰éˆ•é‡æ–°è¨­å®šå®Œæ•´åƒæ•¸');
      remember(); // å„²å­˜æ–°è¨­å®š
    } catch (e) {
      log('âŒ æ¸…ç†è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + e.message);
    }
  };

})();
</script>
</body>
</html>
